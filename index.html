<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invito Laurea Valeria</title>
    <meta name="description" content="Siete invitati alla Laurea di Valeria. Apri l'invito interattivo con tutti i dettagli." />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="it_IT" />
    <meta property="og:title" content="Laurea di Valeria - Sei invitato!" />
    <meta property="og:description" content="25 Febbraio 2026 proclamazione e 27 Febbraio 2026 festeggiamenti. Apri l'invito completo." />
    <meta property="og:url" content="https://filippodigesu.github.io/Laurea-Valeria-Invito/" />
    <meta property="og:image" content="https://filippodigesu.github.io/Laurea-Valeria-Invito/cover.jpg" />
    <meta property="og:image:type" content="image/jpeg" />
    <meta property="og:image:width" content="1080" />
    <meta property="og:image:height" content="1528" />
    <meta property="og:site_name" content="Laurea di Valeria" />
    <meta name="twitter:card" content="summary_large_image" />
    <link rel="canonical" href="https://filippodigesu.github.io/Laurea-Valeria-Invito/" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Manrope:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-1: #f4ede2;
        --bg-2: #f8f2e8;
        --accent: #c31f6f;
        --accent-2: #7a214d;
        --text: #3b2432;
        --card: #fffdf8;
        --shadow: 0 22px 50px rgba(67, 31, 53, 0.25);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        min-height: 100svh;
        min-height: 100dvh;
        display: grid;
        place-items: center;
        font-family: "Manrope", "Avenir Next", "Segoe UI", sans-serif;
        color: var(--text);
        background:
          radial-gradient(circle at 15% 15%, rgba(195, 31, 111, 0.15), transparent 40%),
          radial-gradient(circle at 85% 80%, rgba(122, 33, 77, 0.12), transparent 45%),
          linear-gradient(160deg, var(--bg-1), var(--bg-2));
        overflow-x: hidden;
        padding-top: 20px;
        padding-bottom: 20px;
        padding-left: max(14px, env(safe-area-inset-left));
        padding-right: max(14px, env(safe-area-inset-right));
        -webkit-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
        isolation: isolate;
      }

      .bg-scene {
        position: fixed;
        inset: 0;
        z-index: 0;
        pointer-events: none;
        overflow: hidden;
      }

      .bg-grid {
        position: absolute;
        inset: -20%;
        background:
          radial-gradient(circle at center, rgba(255, 255, 255, 0.24) 0, rgba(255, 255, 255, 0) 62%),
          repeating-linear-gradient(140deg, rgba(122, 33, 77, 0.055) 0 2px, transparent 2px 22px);
        opacity: 0.4;
        animation: bg-pan 26s linear infinite;
      }

      .orb {
        position: absolute;
        width: min(58vw, 460px);
        aspect-ratio: 1 / 1;
        border-radius: 999px;
        filter: blur(22px);
        opacity: 0.42;
        mix-blend-mode: multiply;
      }

      .orb-1 {
        left: -14%;
        top: -10%;
        background: radial-gradient(circle, rgba(212, 46, 136, 0.78), rgba(212, 46, 136, 0));
        animation: orb-float-a 16s ease-in-out infinite alternate;
      }

      .orb-2 {
        right: -18%;
        top: 24%;
        background: radial-gradient(circle, rgba(122, 33, 77, 0.72), rgba(122, 33, 77, 0));
        animation: orb-float-b 20s ease-in-out infinite alternate;
      }

      .orb-3 {
        left: 22%;
        bottom: -24%;
        background: radial-gradient(circle, rgba(245, 190, 88, 0.52), rgba(245, 190, 88, 0));
        animation: orb-float-c 18s ease-in-out infinite alternate;
      }

      .floaters {
        position: absolute;
        inset: 0;
      }

      .floater {
        position: absolute;
        left: var(--x);
        top: var(--y);
        width: var(--size);
        height: var(--size);
        border-radius: 999px;
        opacity: var(--alpha);
        background: radial-gradient(circle, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.06));
        box-shadow: 0 0 24px rgba(255, 255, 255, 0.24);
        animation: float-rise var(--dur) linear infinite;
        animation-delay: var(--delay);
      }

      .invite {
        position: relative;
        z-index: 2;
        width: min(520px, 100%);
        margin-inline: auto;
        padding: 10px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.68));
        border: 1px solid rgba(122, 33, 77, 0.2);
        border-radius: 28px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(5px);
        overflow: hidden;
        transform: perspective(1100px) rotateX(0deg) rotateY(0deg) scale(1);
        transform-style: preserve-3d;
        transition: transform 140ms ease-out;
        will-change: transform;
      }

      .tilt-shine {
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        z-index: 4;
        opacity: var(--shine-opacity, 0);
        background: radial-gradient(
          280px 220px at var(--shine-x, 50%) var(--shine-y, 50%),
          rgba(255, 255, 255, 0.34),
          rgba(255, 255, 255, 0) 72%
        );
        mix-blend-mode: screen;
        transition: opacity 160ms linear;
      }

      .stage {
        position: relative;
        margin: 0;
        width: 100%;
        border-radius: 22px;
        overflow: hidden;
        background: var(--card);
        aspect-ratio: 3 / 4;
        cursor: pointer;
        border: 2px solid rgba(122, 33, 77, 0.18);
        touch-action: manipulation;
        -webkit-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
      }

      .img-layer {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 700ms cubic-bezier(0.22, 1, 0.36, 1), opacity 550ms ease;
        pointer-events: none;
        -webkit-user-drag: none;
      }

      .cover {
        z-index: 2;
      }

      .details {
        z-index: 1;
        opacity: 0;
        transform: scale(1.08);
      }

      .fx-layer {
        position: absolute;
        inset: 0;
        z-index: 5;
        pointer-events: none;
        overflow: hidden;
      }

      .fx-ripple {
        position: absolute;
        width: 18px;
        height: 18px;
        left: 0;
        top: 0;
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.92);
        background: radial-gradient(circle, rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0));
        transform: translate(-50%, -50%) scale(0.2);
        animation: fx-ripple 500ms ease-out forwards;
      }

      .fx-spark {
        position: absolute;
        width: 8px;
        height: 8px;
        left: 0;
        top: 0;
        border-radius: 2px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 237, 158, 0.95));
        box-shadow: 0 0 12px rgba(255, 255, 255, 0.9);
        transform: translate(-50%, -50%);
        animation: fx-spark 600ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
      }

      @keyframes fx-ripple {
        0% {
          opacity: 0.9;
          transform: translate(-50%, -50%) scale(0.2);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(10);
        }
      }

      @keyframes fx-spark {
        0% {
          opacity: 0.95;
          transform: translate(-50%, -50%) translate(0, 0) rotate(0deg) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) translate(var(--dx), var(--dy)) rotate(40deg) scale(0.4);
        }
      }

      @keyframes bg-pan {
        0% { transform: translate3d(-4%, -2%, 0) rotate(0deg); }
        100% { transform: translate3d(4%, 2%, 0) rotate(4deg); }
      }

      @keyframes orb-float-a {
        0% { transform: translate3d(0, 0, 0) scale(1); }
        100% { transform: translate3d(12%, 10%, 0) scale(1.12); }
      }

      @keyframes orb-float-b {
        0% { transform: translate3d(0, 0, 0) scale(1); }
        100% { transform: translate3d(-16%, 12%, 0) scale(1.08); }
      }

      @keyframes orb-float-c {
        0% { transform: translate3d(0, 0, 0) scale(1); }
        100% { transform: translate3d(8%, -14%, 0) scale(1.1); }
      }

      @keyframes float-rise {
        0% {
          transform: translate3d(0, 0, 0) scale(0.8);
          opacity: 0;
        }
        18% {
          opacity: var(--alpha);
        }
        82% {
          opacity: var(--alpha);
        }
        100% {
          transform: translate3d(var(--drift), -115vh, 0) scale(1.2);
          opacity: 0;
        }
      }

      .invite.revealed .cover {
        opacity: 0;
        transform: scale(1.08) rotate(-2deg);
        pointer-events: none;
      }

      .invite.revealed .details {
        opacity: 1;
        transform: scale(1);
      }

      @media (max-width: 500px) {
        .invite {
          border-radius: 22px;
        }

        .stage {
          border-radius: 16px;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        .bg-grid,
        .orb,
        .floater,
        .img-layer,
        .fx-ripple,
        .fx-spark,
        .invite {
          animation: none !important;
          transition: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="bg-scene" aria-hidden="true">
      <div class="bg-grid"></div>
      <div class="orb orb-1"></div>
      <div class="orb orb-2"></div>
      <div class="orb orb-3"></div>
      <div class="floaters" id="floaters"></div>
    </div>

    <audio id="bgMusic" autoplay loop preload="auto" playsinline muted>
      <source src="music.mp3" type="audio/mpeg" />
    </audio>

    <section class="invite" id="invite">
      <div class="stage" id="stage" role="button" tabindex="0" aria-label="Apri invito laurea">
        <img class="img-layer cover" id="cover" src="cover.webp" alt="Copertina invito laurea" fetchpriority="high" decoding="async" draggable="false" />
        <img class="img-layer details" id="details" src="details.webp" alt="Dettagli invito laurea" loading="lazy" decoding="async" draggable="false" />
        <div class="fx-layer" id="fxLayer" aria-hidden="true"></div>
      </div>
      <div class="tilt-shine" id="tiltShine" aria-hidden="true"></div>
    </section>

    <script>
      const invite = document.getElementById("invite");
      const stage = document.getElementById("stage");
      const cover = document.getElementById("cover");
      const details = document.getElementById("details");
      const fxLayer = document.getElementById("fxLayer");
      const tiltShine = document.getElementById("tiltShine");
      const floaters = document.getElementById("floaters");
      const bgMusic = document.getElementById("bgMusic");
      let revealed = false;
      let musicStarted = false;
      let musicUnlocked = false;
      let pointerTilting = false;
      let gyroListening = false;
      let gyroBaseBeta = null;
      let gyroBaseGamma = null;
      let gyroHasPermission = false;
      let gyroPermissionInFlight = false;
      const reduceMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      const MAX_TILT_DEG = 9;

      bgMusic.volume = 0.35;
      bgMusic.muted = true;
      bgMusic.load();

      function toggleView() {
        revealed = !revealed;
        invite.classList.toggle("revealed", revealed);
      }

      function clamp(value, min, max) {
        return Math.min(max, Math.max(min, value));
      }

      function applyTilt(normX, normY, strength = 1) {
        if (reduceMotion) return;
        invite.style.transition = "transform 0s";
        tiltShine.style.transition = "opacity 40ms linear";
        const rotateY = clamp(normX, -1, 1) * MAX_TILT_DEG * strength;
        const rotateX = clamp(-normY, -1, 1) * MAX_TILT_DEG * strength;
        const scale = 1 + 0.012 * strength;
        invite.style.transform = `perspective(1100px) rotateX(${rotateX.toFixed(2)}deg) rotateY(${rotateY.toFixed(2)}deg) scale(${scale.toFixed(3)})`;
        tiltShine.style.setProperty("--shine-x", `${((clamp(normX, -1, 1) + 1) * 50).toFixed(1)}%`);
        tiltShine.style.setProperty("--shine-y", `${((clamp(normY, -1, 1) + 1) * 50).toFixed(1)}%`);
        tiltShine.style.setProperty("--shine-opacity", `${(0.18 + 0.22 * strength).toFixed(2)}`);
      }

      function resetTilt() {
        if (reduceMotion) return;
        invite.style.transition = "transform 150ms ease-out";
        tiltShine.style.transition = "opacity 140ms ease-out";
        invite.style.transform = "perspective(1100px) rotateX(0deg) rotateY(0deg) scale(1)";
        tiltShine.style.setProperty("--shine-opacity", "0");
      }

      function handleGlobalPointerTilt(event) {
        if (reduceMotion) return;
        if (event.pointerType && event.pointerType !== "mouse" && event.pointerType !== "pen") return;
        pointerTilting = true;
        const x = clamp(event.clientX / window.innerWidth, 0, 1);
        const y = clamp(event.clientY / window.innerHeight, 0, 1);
        applyTilt(x * 2 - 1, y * 2 - 1, 0.95);
      }

      function startGyroListening() {
        if (gyroListening || reduceMotion) return;
        window.addEventListener("deviceorientation", handleDeviceOrientation, true);
        window.addEventListener("deviceorientationabsolute", handleDeviceOrientation, true);
        gyroListening = true;
      }

      async function enableGyroFromGesture() {
        if (reduceMotion || gyroHasPermission || typeof DeviceOrientationEvent === "undefined") return;
        if (typeof DeviceOrientationEvent.requestPermission === "function") {
          if (gyroPermissionInFlight) return;
          gyroPermissionInFlight = true;
          try {
            const permissionState = await DeviceOrientationEvent.requestPermission();
            if (permissionState === "granted") {
              gyroHasPermission = true;
              startGyroListening();
            }
          } catch (_) {
            // iOS can reject when the gesture context is invalid.
          } finally {
            gyroPermissionInFlight = false;
          }
          return;
        }
        gyroHasPermission = true;
        startGyroListening();
      }

      function handleDeviceOrientation(event) {
        if (reduceMotion || pointerTilting) return;
        if (event.beta == null || event.gamma == null) return;
        if (gyroBaseBeta === null || gyroBaseGamma === null) {
          gyroBaseBeta = event.beta;
          gyroBaseGamma = event.gamma;
        }
        // Mobile gyroscope axes are intentionally inverted for a more natural card reaction.
        const normX = clamp(-(event.gamma - gyroBaseGamma) / 20, -1, 1);
        const normY = clamp(-(event.beta - gyroBaseBeta) / 20, -1, 1);
        applyTilt(normX, normY, 0.9);
      }

      function handleUserGesture() {
        enableGyroFromGesture();
        unlockMusic();
      }

      stage.addEventListener("click", () => {
        handleUserGesture();
        toggleView();
      });
      stage.addEventListener("pointerdown", (event) => {
        handleUserGesture();
        spawnEffect(event.clientX, event.clientY);
      });
      window.addEventListener("pointermove", handleGlobalPointerTilt);
      document.addEventListener("mouseleave", () => {
        pointerTilting = false;
        resetTilt();
      });
      window.addEventListener("pointerup", () => {
        pointerTilting = false;
        if (!gyroListening) {
          resetTilt();
        }
      });
      window.addEventListener("pointercancel", () => {
        pointerTilting = false;
        if (!gyroListening) {
          resetTilt();
        }
      });
      window.addEventListener("blur", () => {
        pointerTilting = false;
        if (!gyroListening) {
          resetTilt();
        }
      });
      stage.addEventListener("contextmenu", (event) => {
        event.preventDefault();
      });
      stage.addEventListener("dragstart", (event) => {
        event.preventDefault();
      });
      stage.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          handleUserGesture();
          const rect = stage.getBoundingClientRect();
          spawnEffect(rect.left + rect.width / 2, rect.top + rect.height / 2);
          toggleView();
        }
      });

      function stopUnlockListeners() {
        // Keep gesture listeners active so iOS gyroscope permission can be retried.
        window.removeEventListener("focus", unlockMusic);
      }

      function startMusic() {
        const playPromise = bgMusic.play();
        if (!playPromise || typeof playPromise.then !== "function") {
          musicStarted = true;
          return;
        }
        playPromise
          .then(() => {
            musicStarted = true;
          })
          .catch(() => {
            // If blocked, we retry on the next user gesture.
          });
      }

      function unlockMusic() {
        if (musicUnlocked) return;
        bgMusic.muted = false;
        startMusic();
        if (!bgMusic.paused) {
          musicUnlocked = true;
          stopUnlockListeners();
        }
      }

      startMusic();
      document.addEventListener("pointerdown", handleUserGesture);
      document.addEventListener("touchstart", handleUserGesture, { passive: true });
      document.addEventListener("click", handleUserGesture);
      document.addEventListener("keydown", handleUserGesture);
      window.addEventListener("focus", unlockMusic);
      bgMusic.addEventListener("playing", () => {
        musicStarted = true;
        if (!bgMusic.muted) {
          musicUnlocked = true;
          stopUnlockListeners();
        }
      });

      document.addEventListener("visibilitychange", () => {
        if (!document.hidden && musicUnlocked && bgMusic.paused) {
          startMusic();
        }
      });

      function setupFallbacks(img, sources) {
        let index = 0;
        img.src = sources[index];
        img.addEventListener("error", () => {
          index += 1;
          if (index < sources.length) {
            img.src = sources[index];
          }
        });
      }

      setupFallbacks(cover, ["cover.webp", "cover.jpg", "cover.jpeg", "cover.png"]);
      setupFallbacks(details, ["details.webp", "details.jpg", "details.jpeg", "details.png"]);
      buildFloaters(26);
      if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission !== "function") {
        gyroHasPermission = true;
        startGyroListening();
      }

      function spawnEffect(clientX, clientY) {
        const rect = stage.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        const ripple = document.createElement("span");
        ripple.className = "fx-ripple";
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        fxLayer.appendChild(ripple);

        const sparkVectors = [
          [36, 0],
          [26, 24],
          [0, 36],
          [-26, 24],
          [-36, 0],
          [-26, -24],
          [0, -36],
          [26, -24],
        ];

        sparkVectors.forEach(([dx, dy]) => {
          const spark = document.createElement("span");
          spark.className = "fx-spark";
          spark.style.left = `${x}px`;
          spark.style.top = `${y}px`;
          spark.style.setProperty("--dx", `${dx}px`);
          spark.style.setProperty("--dy", `${dy}px`);
          fxLayer.appendChild(spark);
          spark.addEventListener("animationend", () => spark.remove(), { once: true });
        });

        ripple.addEventListener("animationend", () => ripple.remove(), { once: true });
      }

      function buildFloaters(count) {
        const frag = document.createDocumentFragment();
        for (let i = 0; i < count; i += 1) {
          const dot = document.createElement("span");
          const x = `${Math.random() * 100}%`;
          const y = `${60 + Math.random() * 70}%`;
          const size = `${4 + Math.random() * 12}px`;
          const alpha = (0.22 + Math.random() * 0.48).toFixed(2);
          const dur = `${11 + Math.random() * 16}s`;
          const delay = `${-Math.random() * 18}s`;
          const drift = `${(Math.random() * 90 - 45).toFixed(0)}px`;
          dot.className = "floater";
          dot.style.setProperty("--x", x);
          dot.style.setProperty("--y", y);
          dot.style.setProperty("--size", size);
          dot.style.setProperty("--alpha", alpha);
          dot.style.setProperty("--dur", dur);
          dot.style.setProperty("--delay", delay);
          dot.style.setProperty("--drift", drift);
          frag.appendChild(dot);
        }
        floaters.appendChild(frag);
      }
    </script>
  </body>
</html>
